using Newtonsoft.Json.Linq;
using System;
using System.IO;
using System.Linq;
using System.Xml.Linq;

namespace JsonAddAndUpdate
{
    class Program
    {
        private string jsonFile = @"D:\laba.json";
        private void AddCompany()
        {
            Console.WriteLine("Введите ID покупателя : ");
            var buyerId = Console.ReadLine();
            Console.WriteLine("\nВведите название улуги : ");
            var buyerName = Console.ReadLine();

            var newBuyerMember = "{ 'buyerId': " + buyerId + ", 'buyerName': '" + buyerName + "'}";
            try
            {
                var json = File.ReadAllText(jsonFile);
                var jsonObj = JObject.Parse(json);
                var experienceArrary = jsonObj.GetValue("buyer") as JArray;
                var newBuyer = JObject.Parse(newBuyerMember);
                experienceArrary.Add(newBuyer);

                jsonObj["buyer"] = experienceArrary;
                string newJsonResult = Newtonsoft.Json.JsonConvert.SerializeObject(jsonObj, Newtonsoft.Json.Formatting.Indented);
                File.WriteAllText(jsonFile, newJsonResult);
            }
            catch (Exception ex)
            {
                Console.WriteLine("Ошибка добавления : " + ex.Message.ToString());
            }
        }

        private void UpdateCompany()
        {
            string json = File.ReadAllText(jsonFile);

            try
            {
                var jObject = JObject.Parse(json);
                JArray experiencesArrary = (JArray)jObject["buyer"];
                Console.Write("Введите ID услуги для изменения её данных : ");
                var buyerid = Convert.ToInt32(Console.ReadLine());

                if (buyerid > 0)
                {
                    Console.Write("Введите новое название услуги : ");
                    var buyerName = Convert.ToString(Console.ReadLine());

                    foreach (var company in experiencesArrary.Where(obj => obj["buyerid"].Value<int>() == buyerid))
                    {
                        company["buyerName"] = !string.IsNullOrEmpty(buyerName) ? buyerName : "";
                    }

                    jObject["buyer"] = experiencesArrary;
                    string output = Newtonsoft.Json.JsonConvert.SerializeObject(jObject, Newtonsoft.Json.Formatting.Indented);
                    File.WriteAllText(jsonFile, output);
                }
                else
                {
                    Console.Write("Неверный ID услуги!");
                    UpdateCompany();
                }
            }
            catch (Exception ex)
            {

                Console.WriteLine("Ошибка добавления : " + ex.Message.ToString());
            }
        }

        private void DeleteCompany()
        {
            var json = File.ReadAllText(jsonFile);
            try
            {
                var jObject = JObject.Parse(json);
                JArray buyerArrary = (JArray)jObject["buyer"];
                Console.Write("Введите ID услуги которую желаете удалить : ");
                var buyerId = Convert.ToInt32(Console.ReadLine());

                if (buyerId > 0)
                {
                    var buyerName = string.Empty;
                    var buyerToDeleted = buyerArrary.FirstOrDefault(obj => obj["buyerid"].Value<int>() == buyerId);

                    buyerArrary.Remove(buyerToDeleted);

                    string output = Newtonsoft.Json.JsonConvert.SerializeObject(jObject, Newtonsoft.Json.Formatting.Indented);
                    File.WriteAllText(jsonFile, output);
                }
                else
                {
                    Console.Write("Неверный ID букета!");
                    UpdateCompany();
                }
            }
            catch (Exception)
            {

                throw;
            }
        }

        private void GetUserDetails()
        {
            var json = File.ReadAllText(jsonFile);
            try
            {
                var jObject = JObject.Parse(json);

                if (jObject != null)
                {
                    Console.WriteLine("ID :" + jObject["id"].ToString());
                    Console.WriteLine("Name :" + jObject["name"].ToString());

                    var address = jObject["address"];
                    Console.WriteLine("Street :" + address["street"].ToString());
                    Console.WriteLine("City :" + address["city"].ToString());
                    JArray buyerArrary = (JArray)jObject["buyer"];
                    if (buyerArrary != null)
                    {
                        foreach (var item in buyerArrary)
                        {
                            Console.WriteLine("buyer Id :" + item["buyerid"]);
                            Console.WriteLine("buyer Name :" + item["buyername"].ToString());
                        }

                    }
                    Console.WriteLine("Phone Number :" + jObject["phoneNumber"].ToString());
                    Console.WriteLine("Role :" + jObject["role"].ToString());

                }
            }
            catch (Exception)
            {

                throw;
            }
        }
        static void Main(string[] args)
        {
            Program objProgram = new JsonAddAndUpdate.Program();

            Console.WriteLine("Выберите свои варианты: 1 - Добавить, 2 - Обновить, 3 - Удалить, 4 - Выбрать \n");
            var option = Console.ReadLine();
            switch (option)
            {
                case "1":
                    objProgram.AddCompany();
                    break;
                case "2":
                    objProgram.UpdateCompany();
                    break;
                case "3":
                    objProgram.DeleteCompany();
                    break;
                case "4":
                    objProgram.GetUserDetails();
                    break;
                default:
                    Main(null);
                    break;
            }
            Console.ReadLine();

        }
    }
}
